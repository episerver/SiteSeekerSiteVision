#!/bin/bash

if [ $# -ne 2 ]; then
    echo "Usage: $0 <epi-xml-file> <sitevision-prop-file>" >&2
    exit 1
fi

XML_FILE="$1"
PROP_FILE="$2"
SEPARATOR='-'

echo "# Don't edit this file! This file was generated by $0" > $PROP_FILE

function get-name() {
    NAME=${1%%>*}
    NAME=${NAME##*<}
    echo -n "$NAME"
}

function get-value() {
    VALUE=${1%<*}
    VALUE=${VALUE#*>}
    echo -n "$VALUE"
}

function parse-line() {
    if [ -n "$1" ]; then
	KEY="$2"
	if [ -n "$3" ]; then
	    KEY="$KEY$SEPARATOR$3"
	fi
	KEY="$KEY$SEPARATOR"$(get-name "$1")
	VALUE=$(get-value "$1")
	echo "$KEY = $VALUE"
    fi
}

unset MODE1
unset MODE2
while read LINE; do
    case $LINE in
	*\<kwic\>*) MODE1=kwic;;
	*\</kwic\>*) unset MODE1;;
	*\<search\>*) MODE1=search;;
	*\</search\>*) unset MODE1;;
	*\<form\>*) MODE1=form;;
	*\</form\>*) unset MODE1;;
	*\<overview\>*) MODE1=overview;;
	*\</overview\>*) unset MODE1;;
	*\<fileformats\>*) 
	    if [ -n "$MODE1" ]; then 
		MODE2=fileformats
	    fi;;
	*\</fileformats\>*) unset MODE2;;
	*\<ages\>*) 
	    if [ -n "$MODE1" ]; then 
		MODE2=ages
	    fi;;
	*\</ages\>*) unset MODE2;;
	*\<languages\>*)
	    if [ -n "$MODE1" ]; then 
		MODE2=languages
	    fi;;
	*\</languages\>*) unset MODE2;;
	*)
	    if [ -n "$MODE1" ]; then
		parse-line "$LINE" "$MODE1" "$MODE2" >> $PROP_FILE
	    fi;;
    esac
done < $XML_FILE

PROP_FILE_LATIN1="${PROP_FILE}.latin1"
iconv -f UTF-8 -t ISO-8859-1 $PROP_FILE > $PROP_FILE_LATIN1
mv $PROP_FILE_LATIN1 $PROP_FILE
